def TEMPLATEPATH = 'https://raw.githubusercontent.com/viaacode/openshift_pipeline-jenkins-exmp/master/openshift/app_deployment-okd.yaml'
def TEMPLATENAME = 'avo2-components'
def TARGET_NS = 'shared-components'
def templatePath = 'https://raw.githubusercontent.comviaacode/avo2-components/master/openshift/app_deployment-okd.yaml'
// NOTE, the "pipeline" directive/closure from the declarative pipeline syntax needs to include, or be nested outside,
// and "openshift" directive/closure from the OpenShift Client Plugin for Jenkins.  Otherwise, the declarative pipeline engine
// will not be fully engaged.
pipeline {
	agent {
		node {
			// spin up a pod to run this build on
			label 'nodejs'
		}
	}
	options {
		// set a timeout of 45 minutes for this pipeline builds are way to slow need to figure out why
		timeout(time: 45, unit: 'MINUTES')
	}
	stages {
		stage('Preamble') {
			steps {
				script {
					openshift.withCluster() {
						openshift.withProject
						("shared-components") {
							echo "Using project: ${openshift.project()}"
						}
					}
				}
			}
		}

		stage('Build') {
			steps {
				script {
					openshift.withCluster() {
						openshift.withProject("shared-components") {
							sh '''
							#!/bin/bash
							rm -f /tmp/.npmrc
							npm --registry=https://registry.npmjs.org install && npm run build
							'''
						}
					}
				} // script
			} // steps
		} // stage

		stage('Publish') {
			steps {

				script {
					openshift.withCluster() {
						openshift.withProject("shared-components") {

							echo "Publishing package to registry"
							sh '''
							#/bin/bash
							cp/home/jenkins/.npm-global/etc/npmrc /tmp/.npmrc
							npm publish
							echo "removing .npmrc for install if node is the same we need to set registry for push nexus not seems to like @viaa:registry=.."
							rm -f /tmp/.npmrc
							'''
						}
					}
				} // script
			} // steps
		} // stage
	} // stages
} // pipeline
